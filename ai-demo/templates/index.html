<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CyberVerse AI Interview | Dimension</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,300;0,600;1,300;1,600&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/css/fontawesome-all.min.css" />
    <!-- HTML5UP Dimension Template CSS (merged with your custom overrides) -->
    <link rel="stylesheet" href="/static/css/dimension-custom.css" />
    <noscript>
      <link rel="stylesheet" href="/static/css/noscript.css" />
    </noscript>
    <style>
      /* Temporary styles for video feed */
      #videoFeedTech,
      #videoFeedHR {
        display: none;
        margin-top: 1rem;
        border: 1px solid #ccc;
      }
      .video-container {
        text-align: center;
      }

      /* Dimension-inspired transitions and animations */
      #bg:after {
        filter: none;
        transition: filter 0.5s ease-in-out;
      }
      body.is-article-visible #bg:after {
        filter: blur(1rem);
      }
      body.is-preload #bg:before {
        background-color: transparent;
      }
      #main {
        position: relative;
        width: 100%;
        max-width: 40rem;
        margin: 0 auto;
      }
      #main article {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        opacity: 0;
        transition: all 0.8s ease-in-out;
        transform: none;
      }
      /* Initial disordered state from Dimension */
      body.is-preload #main article {
        opacity: 0;
      }
      body.is-preload #tech {
        transform: translate(-100px, -50px) rotate(10deg);
      }
      body.is-preload #hr {
        transform: translate(150px, 100px) rotate(-15deg);
      }
      body.is-preload #resume {
        transform: translate(-80px, 200px) rotate(20deg);
      }
      body.is-preload #about {
        transform: translate(120px, -150px) rotate(-10deg);
      }
      body.is-preload #home {
        transform: translate(0, 0);
        opacity: 1;
      }
      /* Active state */
      #main article.active {
        opacity: 1;
        transform: translate(0, 0) rotate(0deg);
        z-index: 2;
      }
      body.is-preload #header,
      body.is-preload #footer {
        opacity: 0;
        transform: translateY(-20px);
      }
      body:not(.is-preload) #header,
      body:not(.is-preload) #footer {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.5s ease-in-out;
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- Background (from Dimension template) -->
    <div id="bg"></div>

    <!-- Wrapper -->
    <div id="wrapper">
      <!-- Single Header (from Dimension template) -->
      <header id="header">
        <div class="logo">
          <span class="icon fa-gem"></span>
        </div>
        <div class="content">
          <div class="inner">
            <h1><a href="#">CyberVerse AI Interview</a></h1>
            <p>Advanced AI-powered interview preparation system</p>
          </div>
        </div>
        <nav>
          <ul>
            <li><a href="#home" class="nav-link">Home</a></li>
            <li><a href="#tech" class="nav-link">Tech Interview</a></li>
            <li><a href="#hr" class="nav-link">HR Interview</a></li>
            <li><a href="#resume" class="nav-link">Upload Resume</a></li>
            <li><a href="#about" class="nav-link">About</a></li>
          </ul>
        </nav>
      </header>

      <!-- Main Content Area -->
      <div id="main">
        <!-- Home Section (no active class initially) -->
        <article id="home">
          <div class="content">
            <header>
              <h2>Welcome to CyberVerse AI</h2>
              <p>Prepare for your future with our advanced interview system.</p>
            </header>
            <div class="inner">
              <div class="box">
                <p>
                  The CyberVerse AI Interview System leverages cutting-edge
                  technology to help you prepare for both technical and HR
                  interviews. Experience a futuristic interface with real-time
                  feedback, audio responses, and facial emotion analysis.
                </p>
                <ul class="actions">
                  <li>
                    <a href="#tech" class="button nav-link">
                      <i class="fas fa-code"></i> Start Tech Interview
                    </a>
                  </li>
                  <li>
                    <a href="#hr" class="button nav-link">
                      <i class="fas fa-users"></i> Start HR Interview
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <span class="close"></span>
        </article>

        <!-- Tech Interview Section -->
        <article id="tech">
          <div class="content">
            <header>
              <h2>Tech Interview</h2>
              <p>Test your technical skills with AI-driven questions.</p>
            </header>
            <div class="inner">
              <div class="box">
                <ul class="actions stacked">
                  <li>
                    <button id="startInterviewTech" class="button">
                      <i class="fas fa-play"></i> Start Tech Interview
                    </button>
                  </li>
                  <li>
                    <button id="startRecordingTech" class="button">
                      <i class="fas fa-microphone"></i> Start Recording
                    </button>
                  </li>
                  <li>
                    <button id="stopRecordingTech" disabled class="button">
                      <i class="fas fa-stop"></i> Stop Recording
                    </button>
                  </li>
                </ul>
                <audio id="audioPlayerTech" controls></audio>
                <p id="questionTextTech"></p>
                <p id="feedbackTextTech"></p>
                <div class="video-container">
                  <video
                    id="videoFeedTech"
                    width="320"
                    height="240"
                    autoplay
                  ></video>
                  <button
                    id="startCameraTech"
                    class="button"
                    style="margin-top: 1rem"
                  >
                    <i class="fas fa-video"></i> Start Camera
                  </button>
                  <button
                    id="stopCameraTech"
                    class="button"
                    style="margin-top: 1rem; display: none"
                  >
                    <i class="fas fa-video-slash"></i> Stop Camera
                  </button>
                </div>
              </div>
            </div>
          </div>
          <span class="close"></span>
        </article>

        <!-- HR Interview Section -->
        <article id="hr">
          <div class="content">
            <header>
              <h2>HR Interview</h2>
              <p>Prepare for behavioral and situational questions.</p>
            </header>
            <div class="inner">
              <div class="box">
                <ul class="actions stacked">
                  <li>
                    <button id="startInterviewHR" class="button">
                      <i class="fas fa-play"></i> Start HR Interview
                    </button>
                  </li>
                  <li>
                    <button id="startRecordingHR" class="button">
                      <i class="fas fa-microphone"></i> Start Recording
                    </button>
                  </li>
                  <li>
                    <button id="stopRecordingHR" disabled class="button">
                      <i class="fas fa-stop"></i> Stop Recording
                    </button>
                  </li>
                </ul>
                <audio id="audioPlayerHR" controls></audio>
                <p id="questionTextHR"></p>
                <p id="feedbackTextHR"></p>
                <div class="video-container">
                  <video
                    id="videoFeedHR"
                    width="320"
                    height="240"
                    autoplay
                  ></video>
                  <button
                    id="startCameraHR"
                    class="button"
                    style="margin-top: 1rem"
                  >
                    <i class="fas fa-video"></i> Start Camera
                  </button>
                  <button
                    id="stopCameraHR"
                    class="button"
                    style="margin-top: 1rem; display: none"
                  >
                    <i class="fas fa-video-slash"></i> Stop Camera
                  </button>
                </div>
              </div>
            </div>
          </div>
          <span class="close"></span>
        </article>

        <!-- Resume Upload Section -->
        <article id="resume">
          <div class="content">
            <header>
              <h2>Upload Your Resume</h2>
              <p>
                Extract skills from your resume to enhance your interview prep.
              </p>
            </header>
            <div class="inner">
              <div class="box">
                <form id="resumeForm" enctype="multipart/form-data">
                  <input
                    type="file"
                    id="resumeFile"
                    name="file"
                    accept=".pdf,.docx"
                  />
                  <button type="submit" class="button">
                    <i class="fas fa-upload"></i> Upload and Parse
                  </button>
                </form>
                <p id="skillsOutput"></p>
              </div>
            </div>
          </div>
          <span class="close"></span>
        </article>

        <!-- About Section -->
        <article id="about">
          <div class="content">
            <header>
              <h2>About CyberVerse AI</h2>
              <p>Learn more about our mission and technology.</p>
            </header>
            <div class="inner">
              <div class="box">
                <p>
                  CyberVerse AI is powered by xAI, dedicated to advancing
                  human-AI collaboration. Our interview system uses
                  state-of-the-art AI to simulate real-world interviews, helping
                  candidates improve their skills with audio and facial emotion
                  analysis.
                </p>
                <ul class="icons">
                  <li>
                    <a href="#" class="icon brands fa-twitter"
                      ><span class="label">Twitter</span></a
                    >
                  </li>
                  <li>
                    <a href="#" class="icon brands fa-github"
                      ><span class="label">GitHub</span></a
                    >
                  </li>
                  <li>
                    <a href="#" class="icon brands fa-linkedin"
                      ><span class="label">LinkedIn</span></a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <span class="close"></span>
        </article>
      </div>

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">© 2025 CyberVerse AI.</p>
      </footer>
    </div>

    <!-- Scripts -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/browser.min.js"></script>
    <script src="/static/js/breakpoints.min.js"></script>
    <script src="/static/js/util.js"></script>
    <script src="/static/js/dimension-functions.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Fullscreen helper functions
      function enterFullScreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.mozRequestFullScreen) {
          elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      }
      function exitFullScreen() {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }

      // Removed visibilitychange and ESC key warning events

      function pauseInterview() {
        stopRecording("tech");
        stopRecording("hr");
        stopCamera("tech");
        stopCamera("hr");
        document.getElementById("audioPlayerTech").pause();
        document.getElementById("audioPlayerHR").pause();
      }

      $(document).ready(function () {
        $(".nav-link").on("click", function (e) {
          e.preventDefault();
          const target = $(this).attr("href").substring(1);
          $("#main article").removeClass("active");
          // Open target section immediately
          $(`#${target}`).addClass("active");
          $("#header nav ul li a").removeClass("active");
          $(this).addClass("active");
          window.scrollTo(0, 0);
        });

        $(".close").on("click", function () {
          $("#main article").removeClass("active");
          $("#header nav ul li a").removeClass("active");
          window.scrollTo(0, 0);
        });

        // Remove preload class after initial animation
        setTimeout(() => {
          $("body").removeClass("is-preload");
        }, 100);
      });

      // Interview & Camera functionality code
      let mediaRecorderTech = null,
        mediaRecorderHR = null;
      let audioChunksTech = [],
        audioChunksHR = [];
      let streamTech = null,
        streamHR = null;
      let isRecordingTech = false,
        isRecordingHR = false;
      let videoStreamTech = null,
        videoStreamHR = null;

      document
        .getElementById("startInterviewTech")
        .addEventListener("click", () => {
          enterFullScreen();
          startInterview("tech");
        });
      document
        .getElementById("startRecordingTech")
        .addEventListener("click", () => startRecording("tech"));
      document
        .getElementById("stopRecordingTech")
        .addEventListener("click", () => stopRecording("tech"));
      document
        .getElementById("startCameraTech")
        .addEventListener("click", () => startCamera("tech"));
      document
        .getElementById("stopCameraTech")
        .addEventListener("click", () => stopCamera("tech"));

      document
        .getElementById("startInterviewHR")
        .addEventListener("click", () => {
          enterFullScreen();
          startInterview("hr");
        });
      document
        .getElementById("startRecordingHR")
        .addEventListener("click", () => startRecording("hr"));
      document
        .getElementById("stopRecordingHR")
        .addEventListener("click", () => stopRecording("hr"));
      document
        .getElementById("startCameraHR")
        .addEventListener("click", () => startCamera("hr"));
      document
        .getElementById("stopCameraHR")
        .addEventListener("click", () => stopCamera("hr"));

      async function startInterview(type) {
        const response = await fetch("/start_interview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: type }),
        });
        const data = await response.json();
        if (data.error) return console.error("Error:", data.error);
        const suffix = type === "tech" ? "Tech" : "HR";
        document.getElementById(`questionText${suffix}`).textContent =
          data.question;
        document.getElementById(
          `audioPlayer${suffix}`
        ).src = `/static/${data.audio}`;
        document.getElementById(`audioPlayer${suffix}`).play();
        document.getElementById(`feedbackText${suffix}`).textContent = "";
      }

      async function startRecording(type) {
        const suffix = type === "tech" ? "Tech" : "HR";
        let mediaRecorder, audioChunks, stream;
        if (type === "tech") {
          if (isRecordingTech) return;
          isRecordingTech = true;
          audioChunks = audioChunksTech;
        } else {
          if (isRecordingHR) return;
          isRecordingHR = true;
          audioChunks = audioChunksHR;
        }
        document.getElementById(`startRecording${suffix}`).disabled = true;
        document.getElementById(`stopRecording${suffix}`).disabled = false;
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          if (type === "tech") {
            mediaRecorderTech = mediaRecorder;
            streamTech = stream;
          } else {
            mediaRecorderHR = mediaRecorder;
            streamHR = stream;
          }
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) audioChunks.push(event.data);
          };
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            audioChunks.length = 0;
            const formData = new FormData();
            formData.append("audio", audioBlob, "response.webm");
            formData.append("type", type);
            const videoFeed = document.getElementById(`videoFeed${suffix}`);
            if (videoFeed.srcObject) {
              const canvas = document.createElement("canvas");
              canvas.width = videoFeed.videoWidth;
              canvas.height = videoFeed.videoHeight;
              const context = canvas.getContext("2d");
              context.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
              const imageData = canvas.toDataURL("image/jpeg").split(",")[1];
              formData.append("image_data", imageData);
            }
            const response = await fetch("/submit_response", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            if (data.error) console.error("Error:", data.error);
            else {
              document.getElementById(`questionText${suffix}`).textContent =
                data.question;
              document.getElementById(
                `audioPlayer${suffix}`
              ).src = `/static/${data.audio}`;
              document.getElementById(`audioPlayer${suffix}`).play();
              document.getElementById(`feedbackText${suffix}`).textContent =
                data.feedback || "";
            }
            if (type === "tech") isRecordingTech = false;
            else isRecordingHR = false;
            document.getElementById(`startRecording${suffix}`).disabled = false;
            document.getElementById(`stopRecording${suffix}`).disabled = true;
          };
          mediaRecorder.start();
        } catch (error) {
          console.error(`Error starting recording for ${type}:`, error);
          alert("Could not access microphone. Please allow permissions.");
          if (type === "tech") isRecordingTech = false;
          else isRecordingHR = false;
          document.getElementById(`startRecording${suffix}`).disabled = false;
          document.getElementById(`stopRecording${suffix}`).disabled = true;
        }
      }

      function stopRecording(type) {
        const suffix = type === "tech" ? "Tech" : "HR";
        let mediaRecorder, stream;
        if (type === "tech") {
          if (!isRecordingTech) return;
          mediaRecorder = mediaRecorderTech;
          stream = streamTech;
          isRecordingTech = false;
        } else {
          if (!isRecordingHR) return;
          mediaRecorder = mediaRecorderHR;
          stream = streamHR;
          isRecordingHR = false;
        }
        if (mediaRecorder && mediaRecorder.state !== "inactive")
          mediaRecorder.stop();
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        if (type === "tech") {
          mediaRecorderTech = null;
          streamTech = null;
        } else {
          mediaRecorderHR = null;
          streamHR = null;
        }
      }

      async function startCamera(type) {
        const suffix = type === "tech" ? "Tech" : "HR";
        const videoFeed = document.getElementById(`videoFeed${suffix}`);
        const startButton = document.getElementById(`startCamera${suffix}`);
        const stopButton = document.getElementById(`stopCamera${suffix}`);
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
          });
          videoFeed.srcObject = stream;
          if (type === "tech") videoStreamTech = stream;
          else videoStreamHR = stream;
          videoFeed.style.display = "block";
          startButton.style.display = "none";
          stopButton.style.display = "inline-block";
        } catch (error) {
          console.error(`Error accessing camera for ${type}:`, error);
          alert("Could not access camera. Please allow permissions.");
        }
      }

      function stopCamera(type) {
        const suffix = type === "tech" ? "Tech" : "HR";
        const videoFeed = document.getElementById(`videoFeed${suffix}`);
        const startButton = document.getElementById(`startCamera${suffix}`);
        const stopButton = document.getElementById(`stopCamera${suffix}`);
        let videoStream = type === "tech" ? videoStreamTech : videoStreamHR;
        if (videoFeed.srcObject) {
          videoFeed.srcObject.getTracks().forEach((track) => track.stop());
          videoFeed.srcObject = null;
          videoFeed.style.display = "none";
          startButton.style.display = "inline-block";
          stopButton.style.display = "none";
          if (type === "tech") videoStreamTech = null;
          else videoStreamHR = null;
        }
      }

      document
        .getElementById("resumeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData();
          const fileInput = document.getElementById("resumeFile");
          if (!fileInput.files.length) {
            document.getElementById("skillsOutput").textContent =
              "Please select a file.";
            return;
          }
          formData.append("file", fileInput.files[0]);
          try {
            const response = await fetch("/upload_resume", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            if (data.error) {
              document.getElementById(
                "skillsOutput"
              ).textContent = `Error: ${data.error}`;
            } else {
              document.getElementById(
                "skillsOutput"
              ).textContent = `Skills: ${data.skills.join(", ")}`;
            }
          } catch (error) {
            console.error("Error uploading resume:", error);
            document.getElementById("skillsOutput").textContent =
              "Error uploading resume.";
          }
        });

      $(".nav-link, .close").on("click", function () {
        stopRecording("tech");
        stopRecording("hr");
        stopCamera("tech");
        stopCamera("hr");
        document.getElementById("questionTextTech").textContent = "";
        document.getElementById("questionTextHR").textContent = "";
        document.getElementById("feedbackTextTech").textContent = "";
        document.getElementById("feedbackTextHR").textContent = "";
        document.getElementById("audioPlayerTech").src = "";
        document.getElementById("audioPlayerHR").src = "";
      });
    </script>
  </body>
</html>
